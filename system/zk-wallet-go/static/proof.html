<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Proof | zk-wallet-go</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/app.css" />
</head>
<body>

<div class="shell">
  <header>
    <div class="row nav">
      <h1>Zero-Knowledge Proof</h1>
      <div class="nav-right">
        <a class="btn secondary" href="/">Home</a>
        <a class="btn secondary" href="/offer.html">Offer</a>
        <a class="btn secondary" href="/wallet.html">Wallet</a>
        <a class="btn secondary" href="/proof.html">Proof</a>
        <a class="btn" id="loginBtn" href="/auth/dsnet/login">Login</a>
        <a class="btn secondary" id="logoutBtn" href="/auth/logout" style="display:none;">Logout</a>
      </div>
    </div>
  </header>
  <main>
    <div class="card">
      <h2>ZKP request</h2>
      <div style="height:8px;"></div>
      <input id="reqInput" type="text" placeholder="request_id" autocomplete="off">
      <div class="row btn-row">
        <button class="btn" id="runBtn">Submit proof</button>
      </div>
    </div>
    <pre id="verifyBox" style="margin-top:12px; display:none;">No response yet.</pre>
  </main>
</div>

<script>
    const verifyBox = document.getElementById("verifyBox");
    const input = document.getElementById("reqInput");
    const runBtn = document.getElementById("runBtn");

    function setStatus(msg) {
        verifyBox.style.display = 'block';
        verifyBox.className = '';
        verifyBox.textContent = msg;
    }

    async function run() {
        const reqId = document.getElementById("reqInput").value.trim();

        if (!reqId) {
            setStatus("Provide request_id.");
            return;
        }

        verifyBox.style.display = 'block';
        verifyBox.className = '';
        verifyBox.textContent = "Processing...";

        try {
            const resp = await fetch("/wallet/zkp/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    request_id: reqId,
                })
            });

            const text = await resp.text();

            try {
                verifyBox.textContent = JSON.stringify(JSON.parse(text), null, 2);
            } catch {
                verifyBox.textContent = text;
            }

        } catch (err) {
            setStatus("Network error: " + err);
            verifyBox.style.display = 'block';
        }
    }

    document.getElementById("runBtn").addEventListener("click", run);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") run(); });

    async function refreshSessionUI() {
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        try {
            const res = await fetch('/auth/me', { credentials:'include' });
            if (res.ok) {
                const u = await res.json();
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline';
            } else {
                loginBtn.style.display = 'inline';
                logoutBtn.style.display = 'none';
            }
        } catch {
            loginBtn.style.display = 'inline';
            logoutBtn.style.display = 'none';
        }
    }
    refreshSessionUI();

    // Prefill from URL params, optional autorun
    const params = new URLSearchParams(window.location.search);
    const initial = params.get('request_id');
    if (initial) {
        input.value = initial;
    }
    if (initial && params.get('autorun')) {
        run();
    }
</script>

</body>
</html>
